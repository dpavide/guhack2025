# Database Schema Fixes - 2025-11-08

## Critical Errors Fixed

### 1. ✅ Rewards Table - Column Not Found Errors
**Problem**: Code referenced non-existent columns in `rewards` table
- Error: `column rewards.created_at does not exist`
- Error: `Could not find the 'last_updated' column of 'rewards'`

**Actual Schema**: `rewards` table has ONLY 3 columns:
- `id` (uuid, primary key)
- `user_id` (uuid, foreign key to profiles)
- `total_credits` (numeric)

**Fixes Applied**:
1. **db.py line 594** - Removed `.order("created_at")` from credit log query
2. **db.py line 730** - Removed `last_updated` from redemption update
3. **db.py line 622** - Removed references to non-existent fields in fallback mapping

### 2. ✅ RewardID Type Mismatch
**Problem**: `shop_item_id` is `integer` in database but Pydantic model expects `string`
- Error: `ValidationError: RewardID Input should be a valid string [type=string_type, input_value=1, input_type=int]`

**Fix Applied**:
- **db.py line 179** - Convert `shop_item_id` to string in `_reward_to_api()`
- Changed: `"RewardID": row.get("shop_item_id")` 
- To: `"RewardID": str(row.get("shop_item_id"))`

### 3. ✅ Credit Log User ID Type Conversion
**Problem**: `credit_log.user_id` is `integer` but `profiles.id` is `uuid`

**Fix Applied**:
- **db.py line 615** - Added UUID to integer conversion for credit_log queries
- Converts UUID to integer hash to query credit_log table properly

## Database Schema Reference

### Tables with UUID Primary Keys:
- **profiles**: id (uuid), email, full_name, created_at
- **bills**: id (uuid), user_id (uuid FK), ...other fields
- **payments**: id (uuid), user_id (uuid FK), bill_id (uuid FK), ...
- **rewards**: id (uuid), user_id (uuid FK), total_credits (numeric) ← NO created_at, NO last_updated
- **redemptions**: id (uuid), user_id (uuid FK), reward_id (uuid FK), created_at

### Tables with Integer Primary Keys:
- **credit_shop**: shop_item_id (int), item_name, credit_cost, status ← NO icon field
- **credit_log**: log_id (int), user_id (int), change_amount, balance_after, created_at
- **leaderboard**: user_id (int), total_credit_earned, total_redeemed, last_updated

## Testing Status
- [x] Fixed all column reference errors
- [x] Fixed type conversion errors  
- [x] Backend code matches actual Supabase schema
- [ ] Need to restart backend server to test
- [ ] Need to test frontend with new backend

## Next Steps
1. Restart backend: `cd backend && python -m uvicorn main:app --reload --port 8001`
2. Start frontend: `cd frontend && npm run dev`
3. Test rewards page at http://localhost:3000/rewards
4. Verify no more 500 errors
